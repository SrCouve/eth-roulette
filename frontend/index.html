<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <h1 class="text-lg font-bold">Casino Test</h1>

    <div class="p-4 mb-4 text-sm rounded-lg dark:bg-blue-200 dark:text-blue-800 hidden" role="alert" id="alert-wrapper">
        <span class="font-medium" id="info-banner"></span>
    </div>


    <input type="number" class="p-2 border border-solid border-gray-300" id="betAmount">
    <div class="flex flex-row gap-2">
        <button class="p-2 bg-rose-700 text-white makebet" data-bet-value="1">Red</button>
        <button class="p-2 bg-black text-white makebet" data-bet-value="0">Black</button>
        <button class="p-2 bg-green-700 text-white" id="getresult">Get Result</button>
        <button id="getblocknumber">Get Block Number</button>
    </div>


    <p>Blocknumber: <span id="blocknumber">0</span></p>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
    type="application/javascript"></script>
    <script type="module">
        import {abi} from './Casino.json'
        const provider = new ethers.providers.Web3Provider(window.ethereum)
        const contractAddress = '0x5FbDB2315678afecb367f032d93F642f64180aa3';
        provider.send("eth_requestAccounts", []);
        const signer = provider.getSigner();

        async function main() {
            const contract = new ethers.Contract(contractAddress, abi, signer);
            let blocktowaitfor;


            provider.once('GameResult', (player, amount, won) => {
                console.log("Gameresult")
                console.log(player, amount, won);
            })

            const betButtons = document.querySelectorAll('.makebet');
            const amount = document.querySelector('#betAmount');
            const resultButton = document.querySelector('#getresult');
            const blocknumberbtn = document.querySelector('#getblocknumber');


            blocknumberbtn.addEventListener('click', (e) => {
                getBlockNumber();
            });


            resultButton.addEventListener('click', async (e) => {
                await getPayout();
            });

            betButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    makeBet(button.dataset.betValue, amount.value)
                });
            });

            await contract.on('BetMade', (player, amount, bet, blocknr) => {
                console.log("Betmade: ", player, amount, bet, blocknr);
                blocktowaitfor = blocknr.toNumber();
            });

            await contract.on('GameResult', (one, two, three) => {
                console.log("Result: ", one, two, three);
            });


            provider.on("block", (async blocknumber => {
                console.log(blocknumber,":", blocktowaitfor)

                if(blocknumber >= blocktowaitfor) {
                    console.log("Result is ready!");
                    let result = await getResult();
                    showResult(result);
                }
            }));


            async function makeBet(color, value) {
                const betAmount = ethers.utils.parseEther(value);
                const tx = await contract.setRougeNoir(color, {value: betAmount});
            }

            async function getResult() {
                console.log("Getting result");
                return await contract.getRougeNoirResult();
            }

            async function getPayout() {
                return await contract.getRougeNoirPayout();
            }

            async function getBlockNumber() {
                let blocknr =  await provider.getBlockNumber();
                let span = document.querySelector('#blocknumber');
                span.innerHTML = blocknr;
            }

            function showResult(won) {
                const infoSpan = document.querySelector('#info-banner');
                const alertWrapper = document.querySelector('#alert-wrapper');
                alertWrapper.classList.remove('hidden');
                if(won) {
                    infoSpan.innerHTML = 'Congratulations, you won!';
                    alertWrapper.classList.add('text-green-700 bg-green-100');
                } else {
                    infoSpan.innerHTML = 'Sorry, you lost :(';
                    alertWrapper.classList.add('text-red-700 bg-red-100');
                }
            }
        }

        main();
    </script>
</body>
</html>