<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <h1 class="text-lg font-bold">Casino Test</h1>


    <input type="number" class="p-2 border border-solid border-gray-300" id="betAmount">
    <div class="flex flex-row gap-2">
        <button class="p-2 bg-rose-700 text-white makebet" data-bet-value="1">Red</button>
        <button class="p-2 bg-black text-white makebet" data-bet-value="0">Black</button>
        <button class="p-2 bg-green-700 text-white" id="getresult">Get Result</button>
        <button id="getblocknumber">Get Block Number</button>
    </div>

    <p>Blocknumber: <span id="blocknumber">0</span></p>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
    type="application/javascript"></script>
    <script type="module">
        import {abi} from './Casino.json'
        const provider = new ethers.providers.Web3Provider(window.ethereum)
        const contractAddress = '0x5FbDB2315678afecb367f032d93F642f64180aa3';
        provider.send("eth_requestAccounts", []);
        const signer = provider.getSigner();

        async function main() {
            const contract = new ethers.Contract(contractAddress, abi, signer);
            let blocktowaitfor;
            provider.on('GameResult', (player, amount, won) => {
                console.log("Gameresult")
                console.log(player, amount, won);
            })
            provider.on("block", (blocknumber => {
                console.log(blocknumber,":", blocktowaitfor)

                if(blocknumber >= blocktowaitfor) {
                    console.log("Result is ready!");
                }
            }))
            // wait for the transaction to be mined
            // const receipt = await tx.wait();


            const betButtons = document.querySelectorAll('.makebet');
            const amount = document.querySelector('#betAmount');
            const resultButton = document.querySelector('#getresult');
            const blocknumberbtn = document.querySelector('#getblocknumber');


            blocknumberbtn.addEventListener('click', (e) => {
                getBlockNumber();
            })


            resultButton.addEventListener('click', (e) => {
                getResult();
            })

            betButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    makeBet(button.dataset.betValue, amount.value)
                });
            })

            await contract.on('BetMade', (one, two, three, blocknr) => {
                console.log("Betmade: ", one, two, three, blocknr);
                blocktowaitfor = blocknr.toNumber();
            })

            await contract.on('GameResult', (one, two, three) => {
                console.log("Result: ", one, two, three);
            })



            async function makeBet(color, value) {
                const betAmount = ethers.utils.parseEther(value);
                const tx = await contract.setRougeNoir(color, {value: betAmount});
                console.log(tx)
                provider.once(tx.hash, (e) => {
                    console.log(e)
                })
            }

            async function getResult() {
                console.log("Getting result");
                let result = await contract.getRougeNoirResult();
                console.log("Result:", result);
            }

            async function getBlockNumber() {
                let blocknr =  await provider.getBlockNumber();
                let span = document.querySelector('#blocknumber');
                span.innerHTML = blocknr;
            }
        }

        main();
    </script>
</body>
</html>